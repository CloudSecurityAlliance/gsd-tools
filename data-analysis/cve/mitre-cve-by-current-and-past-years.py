#!/usr/bin/env python3

import csv
import re
import os

os.system("wget -q https://cve.mitre.org/data/downloads/allitems.csv.gz")
os.system("gzip -d allitems.csv.gz")

CVEAssignedYears = {1999: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2000: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2001: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2002: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2003: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2004: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2005: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2006: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2007: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2008: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2009: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2010: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2011: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2012: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2013: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2014: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2015: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2016: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2017: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2018: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2019: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2020: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2021: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0},
                    2022: {"CVEAssignmentsforCurrentYear":0, "CVEAssignmentsForPreviousYears":0}
}

with open('allitems.csv', newline='',  encoding='ISO-8859-1') as csvfile:
    cvereader= csv.reader(csvfile, delimiter=',', quotechar='"')
    for row in cvereader:
        if re.search('^CVE-', row[0]):
            # Ignore reserved
            if re.search('^\*\* RESERVED \*\* ', row[2]):
                pass
            else:
                # Get the CVE ID Year
                CVEIDYear=re.sub('^CVE-', '', row[0])
                CVEIDYear=re.sub('-[0-9]*$', '', CVEIDYear)

                # If we have an assignedDate value use it, and modify for prior reserved CVEs
                if re.search('Assigned \(', row[4]):
                    assignedDateYear=re.sub('^Assigned \(', '', row[4])
                    assignedDateYear=re.sub('[0-9][0-9][0-9][0-9]\)$', '', assignedDateYear)

                    # Add logic to check for reserved IDs from prior years, if so bump it up to the CVE Year in the ID itself
                    if int(assignedDateYear) < int(CVEIDYear):
                        assignedDateYear = CVEIDYear

                # If we do not have an assignedDate use the CVE year
                else:
                    assignedDateYear=CVEIDYear

                # Write to the correct year counter if assigned in later years
                if int(assignedDateYear) > int(CVEIDYear):
                    CVEAssignedYears[int(assignedDateYear)]["CVEAssignmentsForPreviousYears"] += 1
                else:
                    CVEAssignedYears[int(assignedDateYear)]["CVEAssignmentsforCurrentYear"] += 1

print("Year,CVEAssignmentsForPreviousYears,CVEAssignmentsforCurrentYear")

for entry in CVEAssignedYears:
        print(str(entry) + "," + str(CVEAssignedYears[entry]["CVEAssignmentsForPreviousYears"]) + "," + str(CVEAssignedYears[entry]["CVEAssignmentsforCurrentYear"]))

# To make this a nice excel chart
# Open this in Excel
# Select the headers and data for 1999-2020
# Insert chart, bar, stacked
# Right click on chart, "Select Data"
# Click one orf the two Legend Entries and click "Edit" on the right side ("Horizontal (Category) Axis Labels") and select the years
# Rename "Chart Title" to "CVE Activity"
